#!/usr/bin/env bash
# Rebuild/restart app and run backend tests before allowing push

set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"

echo "[pre-push] Rebuilding and restarting containers..."
# Ensure backend uses test-friendly root credentials matching UI tests
export ROOT_EMAIL="${ROOT_EMAIL:-root@epistula.test}"
export ROOT_PASSWORD="${ROOT_PASSWORD:-root_password_123}"
# Ensure root login policy permits Docker bridge subnet and proxy headers
export EPISTULA_ROOT_LOCAL_ONLY="${EPISTULA_ROOT_LOCAL_ONLY:-true}"
export EPISTULA_TRUST_PROXY="${EPISTULA_TRUST_PROXY:-true}"
export EPISTULA_ROOT_ALLOWED_IPS="${EPISTULA_ROOT_ALLOWED_IPS:-172.16.0.0/12}"
pushd "$ROOT_DIR" >/dev/null
if command -v docker >/dev/null 2>&1; then
  docker compose up -d --build frontend backend
else
  echo "[pre-push] Docker not found; skipping rebuild."
fi
popd >/dev/null

# Health check backend if docker available
if command -v curl >/dev/null 2>&1; then
  echo "[pre-push] Waiting for backend health..."
  for i in {1..20}; do
    if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done

  echo "[pre-push] Waiting for frontend health..."
  for i in {1..20}; do
    if curl -fsS http://localhost:3000/ >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done
fi

# Enforce: if backend code changes, require backend tests to change as well
echo "[pre-push] Checking that code changes include tests..."
UPSTREAM_REF="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)"
if [ -n "$UPSTREAM_REF" ]; then
  BASE_COMMIT="$(git merge-base HEAD "$UPSTREAM_REF" 2>/dev/null || true)"
else
  BASE_COMMIT="$(git rev-parse HEAD~1 2>/dev/null || true)"
fi

if [ -z "${BASE_COMMIT}" ]; then
  echo "[pre-push] Could not determine base commit; skipping test-change check."
else
  CHANGED_FILES="$(git diff --name-only "${BASE_COMMIT}"...HEAD || true)"
  BACKEND_CODE_CHANGED="$(echo "$CHANGED_FILES" | grep -E '^epistula/backend/' | grep -v -E '^epistula/backend/tests/' | grep -v -E 'venv-wsl|__pycache__|\\.pyc$' || true)"
  BACKEND_TESTS_CHANGED="$(echo "$CHANGED_FILES" | grep -E '^epistula/backend/tests/' || true)"
  if [ -n "$BACKEND_CODE_CHANGED" ] && [ -z "$BACKEND_TESTS_CHANGED" ]; then
    echo "[pre-push] ERROR: Backend code changed but no tests were modified." >&2
    echo "Changed backend files:" >&2
    echo "$BACKEND_CODE_CHANGED" >&2
    echo "Please add or update tests under epistula/backend/tests/ before pushing." >&2
    exit 1
  fi
fi

echo "[pre-push] Running backend tests..."
if command -v docker >/dev/null 2>&1; then
  # Prefer running tests inside the backend container to ensure correct deps
  pushd "$ROOT_DIR" >/dev/null
  # Ensure backend is up (already started above); run pytest inside container
  docker compose exec -T backend pytest -q --tb=short
  popd >/dev/null
else
  pushd "$ROOT_DIR/epistula/backend" >/dev/null
  python -m pytest -q --tb=short
  popd >/dev/null
fi

# Run Playwright E2E tests (always)
echo "[pre-push] Running Playwright E2E tests..."
pushd "$ROOT_DIR/epistula/frontend" >/dev/null
# Ensure deps are installed (fast if already present)
npm ci >/dev/null 2>&1 || npm install >/dev/null 2>&1 || true
# Ensure browsers are installed (chromium is enough for CI/local)
if command -v npx >/dev/null 2>&1; then
  npx playwright install chromium >/dev/null 2>&1 || true
fi
# Use the existing frontend on port 3000; config reuses if running.
# Provide root creds matching backend and disable global setup so UI tests can perform login flows.
export EPISTULA_E2E_ENABLE_UI_TESTS=1
export NEXT_PUBLIC_ROOT_EMAIL="${NEXT_PUBLIC_ROOT_EMAIL:-$ROOT_EMAIL}"
export EPISTULA_ROOT_EMAIL="${EPISTULA_ROOT_EMAIL:-$ROOT_EMAIL}"
export EPISTULA_ROOT_PASSWORD="${EPISTULA_ROOT_PASSWORD:-$ROOT_PASSWORD}"
export EPISTULA_E2E_DISABLE_GLOBAL_SETUP=1
# Run full E2E suite
PORT=3000 npm run -s test:e2e
popd >/dev/null

echo "[pre-push] Tests passed. Proceeding with push."
exit 0
