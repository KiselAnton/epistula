#!/usr/bin/env bash
# Rebuild/restart app and run backend tests before allowing push

set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"

echo "[pre-push] Rebuilding and restarting containers..."
pushd "$ROOT_DIR" >/dev/null
if command -v docker >/dev/null 2>&1; then
  docker compose up -d --build frontend backend
else
  echo "[pre-push] Docker not found; skipping rebuild."
fi
popd >/dev/null

# Health check backend if docker available
if command -v curl >/dev/null 2>&1; then
  echo "[pre-push] Waiting for backend health..."
  for i in {1..20}; do
    if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done

  echo "[pre-push] Waiting for frontend health..."
  for i in {1..20}; do
    if curl -fsS http://localhost:3000/ >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done
fi

echo "[pre-push] Running backend tests..."
pushd "$ROOT_DIR/epistula/backend" >/dev/null
python -m pytest -q --tb=short
popd >/dev/null

echo "[pre-push] Tests passed. Proceeding with push."
exit 0
