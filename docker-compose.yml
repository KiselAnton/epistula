# ============================================================================
# ‚ö†Ô∏è  DATA PERSISTENCE WARNING ‚ö†Ô∏è
# 
# This docker-compose.yml uses NAMED VOLUMES for data persistence:
#   - epistula_db_data: PostgreSQL database (ALL your universities, users, etc.)
#   - epistula_minio_data: MinIO storage (uploaded files, logos, documents)
# 
# üîí SAFE OPERATIONS (data persists):
#   docker compose down                  ‚úÖ Volumes preserved
#   docker compose up --build            ‚úÖ Volumes preserved
#   docker compose restart               ‚úÖ Volumes preserved
# 
# ‚ö†Ô∏è  DANGEROUS OPERATIONS (data DELETED):
#   docker compose down -v               ‚ùå DELETES ALL VOLUMES!
#   docker volume rm epistula_db_data    ‚ùå DELETES DATABASE!
#   docker volume prune                  ‚ùå May delete if orphaned!
# 
# üì¶ ALWAYS BACKUP BEFORE RISKY OPERATIONS:
#   .\backup_database.ps1                (Windows)
#   ./backup_database.sh                 (Linux/Mac)
# 
# See DATA_SAFETY.md for complete backup and recovery procedures.
# ============================================================================

services:
  # PostgreSQL Database - PERSISTENT, DO NOT REBUILD
  database:
    image: postgres:16-alpine
    container_name: epistula_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: epistula
      POSTGRES_USER: epistula_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      # Persistent data volume - survives container recreation
      - epistula_db_data:/var/lib/postgresql/data
      # Initialization scripts (run only on first start)
      - ./epistula/database/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - epistula_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U epistula_user -d epistula"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s

  # MinIO Object Storage - S3-compatible storage for files
  minio:
    image: minio/minio:latest
    container_name: epistula_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin_change_me}
    volumes:
      - epistula_minio_data:/data
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    networks:
      - epistula_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s

  # Backend API - Can be rebuilt without affecting database
  backend:
    build:
      context: ./epistula/backend
      dockerfile: Dockerfile
    container_name: epistula_backend
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      # Start when MinIO container has started; backend will retry bucket init if MinIO isn't ready yet
      minio:
        condition: service_started
    environment:
      # Database connection
      DB_HOST: database
      DB_PORT: 5432
      DB_NAME: epistula
      DB_USER: epistula_user
      DB_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
      
      # MinIO connection
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin_change_me}
      MINIO_BUCKET: epistula
      MINIO_USE_SSL: "false"
      
      # Application settings
      EPISTULA_ENV: ${EPISTULA_ENV:-development}
      EPISTULA_CORS_ORIGINS: ${EPISTULA_CORS_ORIGINS:-http://localhost:3000}
      # Root login policy (allow Docker bridge by default for local dev and E2E)
      EPISTULA_ROOT_LOCAL_ONLY: ${EPISTULA_ROOT_LOCAL_ONLY:-true}
      EPISTULA_TRUST_PROXY: ${EPISTULA_TRUST_PROXY:-true}
      EPISTULA_ROOT_ALLOWED_IPS: ${EPISTULA_ROOT_ALLOWED_IPS:-172.16.0.0/12}
      
      # JWT settings
      JWT_SECRET: ${JWT_SECRET:-change_me_in_production_use_strong_random_string}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_MINUTES: ${JWT_EXPIRATION_MINUTES:-60}
      
      # Root user (for initial setup)
      # Default to changeme123 to match .env and E2E tests
      ROOT_EMAIL: ${ROOT_EMAIL:-root@localhost.localdomain}
      ROOT_PASSWORD: ${ROOT_PASSWORD:-changeme123}
      # Reset root password on each start to sync with .env (safe, idempotent)
      RESET_ROOT_PASSWORD_ON_START: ${RESET_ROOT_PASSWORD_ON_START:-1}
      # Backups
      BACKUPS_DIR: /backups/database
      BACKUPS_RETENTION_DAYS: 30
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    networks:
      - epistula_network
    volumes:
      # Mount backend code for development (remove in production)
      - ./epistula/backend:/app:ro
      # Host backups directory (writeable)
      - ./backups:/backups
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Frontend - Can be rebuilt without affecting database
  frontend:
    build:
      context: ./epistula/frontend
      dockerfile: Dockerfile
    container_name: epistula_frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      # Internal backend URL for server-side requests (rewrites, SSR, etc.)
      # Uses Docker network service name instead of localhost
      INTERNAL_BACKEND_URL: http://backend:8000
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - epistula_network
    # In production, run from the built image to ensure fresh assets on each build
    # (If you need live-editing in development, use an override compose file to mount sources.)

networks:
  epistula_network:
    driver: bridge

volumes:
  # CRITICAL: This volume persists database data
  # Do NOT delete this volume unless you want to lose all data
  epistula_db_data:
    driver: local
    name: epistula_db_data
  
  # MinIO persistent storage for uploaded files
  epistula_minio_data:
    driver: local
    name: epistula_minio_data
